<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>èµ›åšç”µå­çƒŸèŠ±</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      margin: 0;
      overflow: hidden;
      background-color: #050505;
      font-family: "Microsoft YaHei", sans-serif;
    }
    
    canvas {
      display: block;
      width: 100vw;
      height: 100vh;
    }
    
    #input_video {
      display: none;
    }
    
    /* æ§åˆ¶å°æ ·å¼ - å‚è€ƒåŸç‰ˆ */
    #control-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 300px;
      max-height: 95vh;
      background: rgba(15, 15, 25, 0.95);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 20px;
      overflow-y: auto;
      color: #fff;
      box-shadow: 0 0 30px rgba(0,0,0,0.6);
      z-index: 100;
      transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
      scrollbar-width: thin;
      scrollbar-color: #555 #1a1a1a;
    }
    
    #control-panel.hidden {
      transform: translateX(320px);
    }
    
    #toggle-panel {
      position: absolute;
      top: 10px;
      right: 320px;
      width: 40px;
      height: 40px;
      background: rgba(15, 15, 25, 0.8);
      border: 1px solid rgba(255,255,255,0.2);
      border-radius: 8px;
      color: white;
      cursor: pointer;
      z-index: 101;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 20px;
      transition: right 0.3s ease;
    }
    
    #toggle-panel.right {
      right: 10px;
    }
    
    h2 {
      margin: 0 0 15px 0;
      font-size: 20px;
      color: #a0a0ff;
      letter-spacing: 2px;
      text-align: center;
      font-weight: bold;
      text-shadow: 0 0 10px rgba(160,160,255,0.3);
    }
    
    h3 {
      margin: 15px 0 10px 0;
      font-size: 14px;
      color: #888;
      border-bottom: 1px solid #333;
      padding-bottom: 5px;
    }
    
    /* å½¢çŠ¶æŒ‰é’® */
    .shape-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 8px;
      margin-bottom: 15px;
    }
    
    .shape-btn {
      background: #1a1a25;
      border: 1px solid #333;
      color: #aaa;
      padding: 8px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      text-align: center;
      transition: all 0.2s;
    }
    
    .shape-btn:hover {
      background: #333;
    }
    
    .shape-btn.active {
      background: #fff;
      color: #000;
      border-color: #fff;
      box-shadow: 0 0 15px rgba(255,255,255,0.4);
      font-weight: bold;
    }
    
    /* å¤šè¡Œæ–‡æœ¬æ¡† */
    #text-input-container {
      margin-bottom: 15px;
      display: none;
    }
    
    textarea#firework-text {
      width: 100%;
      height: 80px;
      box-sizing: border-box;
      background: #111;
      border: 1px solid #444;
      color: #fff;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
      text-align: center;
      resize: vertical;
      font-family: "Microsoft YaHei", sans-serif;
      line-height: 1.5;
    }
    
    textarea#firework-text:focus {
      outline: none;
      border-color: #6c5ce7;
    }
    
    /* æ»‘å— */
    .control-group {
      margin-bottom: 12px;
    }
    
    .label-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
      font-size: 13px;
      color: #ccc;
    }
    
    input[type=range] {
      -webkit-appearance: none;
      width: 100%;
      background: transparent;
      margin: 5px 0;
    }
    
    input[type=range]::-webkit-slider-runnable-track {
      width: 100%;
      height: 6px;
      background: #333;
      border-radius: 3px;
    }
    
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 16px;
      width: 16px;
      border-radius: 50%;
      background: #6c5ce7;
      margin-top: -5px;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(108, 92, 231, 0.8);
      transition: transform 0.1s;
    }
    
    input[type=range]::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }
    
    #hue-slider::-webkit-slider-runnable-track {
      background: linear-gradient(to right, red, yellow, lime, cyan, blue, magenta, red);
    }
    
    /* æç¤ºæ–‡å­— */
    .hint {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(255,255,255,0.5);
      font-size: 14px;
      pointer-events: none;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 1; }
    }
    
    /* éšè—é¢æ¿æ—¶çš„æç¤ºä½ç½® */
    #control-panel.hidden + #toggle-panel + .hint {
      left: calc(50% - 150px);
    }
  </style>
</head>
<body>
  <video id="input_video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>
  
  <button id="toggle-panel">âš™ï¸</button>
  
  <div id="control-panel">
    <h2>ğŸ† èµ›åšç”µå­çƒŸèŠ±</h2>
    
    <h3>çƒŸèŠ±å½¢çŠ¶</h3>
    <div class="shape-grid">
      <button class="shape-btn active" data-shape="sphere">çƒå½¢</button>
      <button class="shape-btn" data-shape="ring">åœ†ç¯</button>
      <button class="shape-btn" data-shape="star">äº”è§’æ˜Ÿ</button>
      <button class="shape-btn" data-shape="heart">çˆ±å¿ƒ</button>
      <button class="shape-btn" data-shape="text">æ–‡å­—</button>
      <button class="shape-btn" data-shape="random">éšæœº</button>
    </div>
    
    <div id="text-input-container">
      <textarea id="firework-text" placeholder="è¯·è¾“å…¥æ–‡å­—ï¼Œä½¿ç”¨é€—å·åˆ†éš”å¤šè¡Œ&#10;ä¾‹å¦‚ï¼šæ–°å¹´å¿«ä¹,ä¸‡äº‹å¦‚æ„,æ­å–œå‘è´¢"></textarea>
    </div>
    
    <h3>ç‰©ç†å‚æ•°</h3>
    <div class="control-group">
      <div class="label-row">
        <span>ç²’å­æ•°é‡</span>
        <span id="particle-count-val">300</span>
      </div>
      <input type="range" id="particle-count" min="50" max="500" value="300">
    </div>
    
    <div class="control-group">
      <div class="label-row">
        <span>æ–‡å­—å¤§å°ç¼©æ”¾</span>
        <span id="text-scale-val">1.0</span>
      </div>
      <input type="range" id="text-scale" min="0.5" max="3" step="0.1" value="1.0">
    </div>
    
    <div class="control-group">
      <div class="label-row">
        <span>é‡åŠ›ç³»æ•°</span>
        <span id="gravity-val">0.12</span>
      </div>
      <input type="range" id="gravity" min="0" max="30" value="12">
    </div>
    
    <h3>è§†è§‰æ•ˆæœ</h3>
    <div class="control-group">
      <div class="label-row">
        <span>æ‹–å°¾é•¿åº¦</span>
        <span id="trail-val">0.15</span>
      </div>
      <input type="range" id="trail" min="0" max="50" value="15">
    </div>
    
    <div class="control-group">
      <div class="label-row">
        <span>é¢œè‰²åŸºè°ƒ</span>
      </div>
      <div class="shape-grid">
        <button class="color-btn active" data-color="rainbow">å½©è‰²</button>
        <button class="color-btn" data-color="red">çº¢è‰²</button>
        <button class="color-btn" data-color="blue">è“è‰²</button>
        <button class="color-btn" data-color="green">ç»¿è‰²</button>
        <button class="color-btn" data-color="gold">é‡‘è‰²</button>
        <button class="color-btn" data-color="purple">ç´«è‰²</button>
      </div>
    </div>
    
    <div class="control-group">
      <div class="label-row">
        <span>äº®åº¦</span>
        <span id="brightness-val">1.0</span>
      </div>
      <input type="range" id="brightness" min="0.2" max="2" step="0.1" value="1.0">
    </div>
    
    <div class="control-group">
      <div class="label-row">
        <span>çˆ†ç‚¸åŠ›åº¦</span>
        <span id="explode-val">1.0</span>
      </div>
      <input type="range" id="explode" min="0.3" max="2" step="0.1" value="1.0">
    </div>
  </div>
  
  <div class="hint">ğŸ‘† ç‚¹å‡»/æåˆæ‰‹æŒ‡å‘å°„çƒŸèŠ±</div>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const video = document.getElementById('input_video');
    
    let width, height;
    let particles = [];
    let fireworks = [];
    let currentShape = 'sphere';
    let currentColor = 'rainbow';
    let particleCount = 300;
    let gravity = 0.12;
    let trailLength = 0.15;
    let textScale = 1.0;
    let brightness = 1.0;
    let explodeForce = 1.0;
    let textLines = ['æ–°å¹´å¿«ä¹', 'ä¸‡äº‹å¦‚æ„'];
    let customText = '';
    
    function resize() {
      width = canvas.width = window.innerWidth;
      height = canvas.height = window.innerHeight;
    }
    
    window.addEventListener('resize', resize);
    resize();
    
    // é¢œè‰²é…ç½®
    const colorPalettes = {
      rainbow: null,
      red: ['#ff0000', '#ff1744', '#ff5252', '#ff8a80', '#ffcdd2'],
      blue: ['#0000ff', '#2979ff', '#448aff', '#82b1ff', '#bbdefb'],
      green: ['#00ff00', '#00e676', '#69f0ae', '#b9f6ca', '#004d40'],
      gold: ['#ffd700', '#ffec8b', '#f0e68c', '#ffa500', '#ff8c00'],
      purple: ['#9c27b0', '#e040fb', '#ea80fc', '#f3e5f5', '#4a148c']
    };
    
    function getColor() {
      if (currentColor === 'rainbow') {
        const hue = Math.random() * 360;
        return `hsl(${hue}, 100%, ${60 * brightness}%)`;
      }
      const palette = colorPalettes[currentColor];
      return palette[Math.floor(Math.random() * palette.length)];
    }
    
    // ç²’å­ç±»
    class Particle {
      constructor(x, y, shape = 'sphere', text = '', isMain = false) {
        this.x = x;
        this.y = y;
        this.shape = shape;
        this.text = text;
        this.isMain = isMain;
        this.init();
      }
      
      init() {
        this.life = 1;
        this.decay = 0.012 + Math.random() * 0.008;
        
        const angle = Math.random() * Math.PI * 2;
        const speed = (Math.random() * 8 + 2) * explodeForce;
        
        if (this.shape === 'sphere') {
          this.vx = Math.cos(angle) * speed;
          this.vy = Math.sin(angle) * speed;
        } else if (this.shape === 'ring') {
          const ringAngle = Math.random() * Math.PI * 2;
          const ringSpeed = (3 + Math.random() * 2) * explodeForce;
          this.vx = Math.cos(ringAngle) * ringSpeed;
          this.vy = Math.sin(ringAngle) * ringSpeed;
        } else if (this.shape === 'star') {
          const starAngle = (Math.floor(Math.random() * 5) * Math.PI * 2 / 5) + (Math.random() - 0.5) * 0.5;
          const starSpeed = (Math.random() * 6 + 2) * explodeForce;
          this.vx = Math.cos(starAngle) * starSpeed;
          this.vy = Math.sin(starAngle) * starSpeed;
        } else if (this.shape === 'heart') {
          const t = Math.random() * Math.PI * 2;
          const heartSpeed = (Math.random() * 5 + 2) * explodeForce;
          this.vx = heartSpeed * Math.sin(t) * Math.cos(t);
          this.vy = heartSpeed * Math.sin(t) - 1;
        } else if (this.shape === 'text' && this.text) {
          this.vx = (Math.random() - 0.5) * 6 * explodeForce;
          this.vy = -Math.random() * 8 * explodeForce - 2;
          this.charIndex = Math.floor(Math.random() * this.text.length);
          this.char = this.text[this.charIndex];
          this.angle = Math.random() * Math.PI * 2;
          this.angularVelocity = (Math.random() - 0.5) * 0.2;
        } else {
          this.vx = (Math.random() - 0.5) * 10 * explodeForce;
          this.vy = (Math.random() - 0.5) * 10 * explodeForce;
        }
        
        this.color = getColor();
        this.size = Math.random() * 3 + 2;
        this.originalSize = this.size;
      }
      
      update() {
        this.x += this.vx;
        this.y += this.vy;
        this.vy += gravity;
        this.vx *= 0.99; // ç©ºæ°”é˜»åŠ›
        this.life -= this.decay;
        
        if (this.shape === 'text' && this.char) {
          this.angle += this.angularVelocity;
        }
        
        this.size = this.originalSize * this.life;
      }
      
      draw() {
        ctx.save();
        ctx.globalAlpha = this.life * brightness;
        
        if (this.shape === 'text' && this.char) {
          ctx.translate(this.x, this.y);
          ctx.rotate(this.angle);
          ctx.font = `${this.size * 12 * textScale}px "Microsoft YaHei", Arial`;
          ctx.fillStyle = this.color;
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.shadowColor = this.color;
          ctx.shadowBlur = 10;
          ctx.fillText(this.char, 0, 0);
        } else {
          ctx.beginPath();
          ctx.fillStyle = this.color;
          ctx.shadowColor = this.color;
          ctx.shadowBlur = 8;
          ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
          ctx.fill();
        }
        
        ctx.restore();
      }
      
      isDead() {
        return this.life <= 0 || this.size < 0.3;
      }
    }
    
    // çƒŸèŠ±å‘å°„å™¨ç±»
    class Firework {
      constructor(x, y) {
        this.x = x;
        this.y = y;
        this.vy = -12 - Math.random() * 4;
        this.exploded = false;
        this.trail = [];
      }
      
      update() {
        if (!this.exploded) {
          this.y += this.vy;
          this.vy += 0.15;
          
          this.trail.push({x: this.x, y: this.y, life: 1});
          this.trail = this.trail.filter(t => {
            t.life -= 0.05;
            return t.life > 0;
          });
          
          if (this.vy >= 0) {
            this.explode();
          }
        }
      }
      
      explode() {
        this.exploded = true;
        
        let shape = currentShape;
        if (shape === 'random') {
          const shapes = ['sphere', 'ring', 'star', 'heart'];
          shape = shapes[Math.floor(Math.random() * shapes.length)];
        }
        
        let text = '';
        if (shape === 'text') {
          const allText = customText || textLines.join(',');
          const lines = allText.split(',').filter(t => t.trim());
          text = lines[Math.floor(Math.random() * lines.length)] || 'ğŸ†';
        }
        
        for (let i = 0; i < particleCount; i++) {
          particles.push(new Particle(this.x, this.y, shape, text, true));
        }
      }
      
      draw() {
        // ç»˜åˆ¶å‘å°„è½¨è¿¹
        this.trail.forEach(t => {
          ctx.beginPath();
          ctx.fillStyle = `rgba(255, 100, 50, ${t.life * 0.5})`;
          ctx.arc(t.x, t.y, 3 * t.life, 0, Math.PI * 2);
          ctx.fill();
        });
        
        // ç»˜åˆ¶å‘å°„å¼¹
        if (!this.exploded) {
          ctx.beginPath();
          ctx.fillStyle = '#ff6432';
          ctx.shadowColor = '#ff6432';
          ctx.shadowBlur = 15;
          ctx.arc(this.x, this.y, 4, 0, Math.PI * 2);
          ctx.fill();
        }
      }
      
      isDead() {
        return this.exploded;
      }
    }
    
    function createFirework(x, y) {
      fireworks.push(new Firework(x, y));
    }
    
    function createClickFirework(x, y) {
      let shape = currentShape;
      if (shape === 'random') {
        const shapes = ['sphere', 'ring', 'star', 'heart'];
        shape = shapes[Math.floor(Math.random() * shapes.length)];
      }
      
      let text = '';
      if (shape === 'text') {
        const allText = customText || textLines.join(',');
        const lines = allText.split(',').filter(t => t.trim());
        text = lines[Math.floor(Math.random() * lines.length)] || 'ğŸ†';
      }
      
      for (let i = 0; i < particleCount; i++) {
        particles.push(new Particle(x, y, shape, text));
      }
    }
    
    function animate() {
      // æ‹–å°¾æ•ˆæœ
      ctx.fillStyle = `rgba(5, 5, 5, ${1 - trailLength})`;
      ctx.fillRect(0, 0, width, height);
      
      // ç»˜åˆ¶èƒŒæ™¯
      ctx.fillStyle = 'rgba(5, 5, 5, 0.1)';
      ctx.fillRect(0, 0, width, height);
      
      // æ›´æ–°å’Œç»˜åˆ¶çƒŸèŠ±
      fireworks = fireworks.filter(fw => {
        fw.update();
        fw.draw();
        return !fw.isDead();
      });
      
      // æ›´æ–°å’Œç»˜åˆ¶ç²’å­
      particles = particles.filter(p => {
        p.update();
        p.draw();
        return !p.isDead();
      });
      
      requestAnimationFrame(animate);
    }
    
    // äº‹ä»¶ç›‘å¬
    let lastTouchTime = 0;
    
    canvas.addEventListener('click', (e) => {
      createClickFirework(e.clientX, e.clientY);
    });
    
    canvas.addEventListener('touchstart', (e) => {
      e.preventDefault();
      const now = Date.now();
      
      if (now - lastTouchTime < 300) {
        // åŒå‡» - å‘å°„çƒŸèŠ±å¼¹
        for (let i = 0; i < 3; i++) {
          setTimeout(() => {
            createFirework(
              Math.random() * width * 0.6 + width * 0.2,
              height * 0.3 + Math.random() * height * 0.2
            );
          }, i * 100);
        }
      } else {
        // å•å‡» - å‘å°„ç²’å­
        for (let i = 0; i < e.touches.length; i++) {
          createClickFirework(e.touches[i].clientX, e.touches[i].clientY);
        }
      }
      
      lastTouchTime = now;
    });
    
    // è§¦æ‘¸ç§»åŠ¨å‘å°„
    canvas.addEventListener('touchmove', (e) => {
      e.preventDefault();
      if (Math.random() < 0.2) {
        createClickFirework(e.touches[0].clientX, e.touches[0].clientY);
      }
    });
    
    // æ§ä»¶äº‹ä»¶
    const controlPanel = document.getElementById('control-panel');
    const toggleBtn = document.getElementById('toggle-panel');
    
    toggleBtn.addEventListener('click', () => {
      controlPanel.classList.toggle('hidden');
      toggleBtn.classList.toggle('right');
      if (controlPanel.classList.contains('hidden')) {
        toggleBtn.style.right = '10px';
        controlPanel.style.transform = 'translateX(320px)';
      } else {
        toggleBtn.style.right = '320px';
        controlPanel.style.transform = 'translateX(0)';
      }
    });
    
    // å½¢çŠ¶æŒ‰é’®
    document.querySelectorAll('.shape-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.shape-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentShape = btn.dataset.shape;
        document.getElementById('text-input-container').style.display = 
          currentShape === 'text' ? 'block' : 'none';
      });
    });
    
    // é¢œè‰²æŒ‰é’®
    document.querySelectorAll('.color-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentColor = btn.dataset.color;
      });
    });
    
    // æ»‘å—
    document.getElementById('particle-count').addEventListener('input', (e) => {
      particleCount = parseInt(e.target.value);
      document.getElementById('particle-count-val').textContent = particleCount;
    });
    
    document.getElementById('gravity').addEventListener('input', (e) => {
      gravity = parseInt(e.target.value) / 100;
      document.getElementById('gravity-val').textContent = gravity.toFixed(2);
    });
    
    document.getElementById('trail').addEventListener('input', (e) => {
      trailLength = parseInt(e.target.value) / 100;
      document.getElementById('trail-val').textContent = trailLength.toFixed(2);
    });
    
    document.getElementById('text-scale').addEventListener('input', (e) => {
      textScale = parseFloat(e.target.value);
      document.getElementById('text-scale-val').textContent = textScale.toFixed(1);
    });
    
    document.getElementById('brightness').addEventListener('input', (e) => {
      brightness = parseFloat(e.target.value);
      document.getElementById('brightness-val').textContent = brightness.toFixed(1);
    });
    
    document.getElementById('explode').addEventListener('input', (e) => {
      explodeForce = parseFloat(e.target.value);
      document.getElementById('explode-val').textContent = explodeForce.toFixed(1);
    });
    
    // æ–‡å­—è¾“å…¥
    document.getElementById('firework-text').addEventListener('input', (e) => {
      customText = e.target.value;
    });
    
    // è‡ªåŠ¨å‘å°„
    setInterval(() => {
      if (Math.random() < 0.25) {
        const x = Math.random() * width * 0.7 + width * 0.15;
        const y = height * 0.2 + Math.random() * height * 0.3;
        createFirework(x, y);
      }
    }, 600);
    
    animate();
  </script>
</body>
</html>
